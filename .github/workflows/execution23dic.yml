name: GraphWord Deployment Hybrid (AWS + LocalStack)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  setup-environment:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3

      - name: Configure AWS credentials
        run: |
          mkdir -p ~/.aws
          echo "[default]" > ~/.aws/credentials
          echo "aws_access_key_id = ASIAUZTGPSLAJ3WWDED7" >> ~/.aws/credentials
          echo "aws_secret_access_key = 7fH8Di3HdAOrl13x1lFwNhFlJjsfhku3NWgOeSz4" >> ~/.aws/credentials
          echo "aws_session_token = IQoJb3JpZ2luX2VjEBcaCXVzLXdlc3QtMiJHMEUCIQCbiFJQKE5EwUEKsCR89X6WoFx1SrtzXm5Udd1zu/r7NgIgJfSWkyDgE1M2YmlV0YKtgJIc4TumoWWgYbGNFAUhKBUqsAII4P//////////ARAAGgwzMjk4NTM2NzAwODAiDHkQyUdOHdUk0seQTCqEAnbQeCEL/QrQb8VWXBGoq1MKMCkaUTRox9zqgDci/WXSFlX+Dia5qcLrE/acpBrluk0qTmfNjUkJhEOS/inuB/P+LW6Pj7yORJ+SGoUthDEj2nYH4cQ1dUefYvJJyzLJ0Gg2Nqj2a8WmITUywx8+zyTAvsUVOy7O64//AqjWeeOyAnen14jLXLEkFoWBk3OvHpawjV8JPCzh/oShS3t9/kil7fW9Ej/z6K1Sg+7mY4WcIcLHEF/gFajNuVvBT2sgHqY7a18LE3aVdLMlxwXg9TwM68vSV2rRfJpHkp+IlBPqQMQEcxN21wgH99lLOFNxK6dcHDuQ9d9lOklBqqyQJLbCEvr7MNPIp7sGOp0B3U0JS8SXeKZp46yVnLGaqyz1D7+ocFB4BgouQzwEKkxWVnhshLr/JlYom3xQtUkwOoKpWoPtcihG/SGsNAkdhsNoOZwqWOOyBjBITFOqbIXfr6uNMoY8zKO44dyibNeea2xmxe/7gpsiYVdBkm1IBlEYBMKQxfa/K075pyJVF5KK5Ko2qu3WxcG2b8FQo/+sAidkpgvA848vRKwgCA==" >> ~/.aws/credentials
          echo "[default]" > ~/.aws/config
          echo "region = us-east-1" >> ~/.aws/config

  start-localstack:
    needs: setup-environment
    runs-on: ubuntu-22.04
    steps:
      - name: Start LocalStack using Docker
        run: |
          docker run -d --name localstack_main -p 4566:4566 -p 4510-4559:4510-4559 -v /var/run/docker.sock:/var/run/docker.sock -e SERVICES="s3,lambda,ec2" localstack/localstack
          sleep 10
          
      - name: Check LocalStack container
        run: |
          for i in {1..60}; do
            RUNNING=$(docker inspect -f '{{.State.Running}}' localstack_main || echo "false")
            if [ "$RUNNING" == "true" ]; then
              echo "LocalStack container is running."
              break
            fi
            echo "Waiting for LocalStack container to start..."
            sleep 5
          done
    
  run-deployment:
    needs: start-localstack
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3
          
      - name: Run deployment script
        env:
          AWS_ACCESS_KEY_ID: ASIAUZTGPSLAJ3WWDED7
          AWS_SECRET_ACCESS_KEY: 7fH8Di3HdAOrl13x1lFwNhFlJjsfhku3NWgOeSz4
          AWS_SESSION_TOKEN: IQoJb3JpZ2luX2VjEBcaCXVzLXdlc3QtMiJHMEUCIQCbiFJQKE5EwUEKsCR89X6WoFx1SrtzXm5Udd1zu/r7NgIgJfSWkyDgE1M2YmlV0YKtgJIc4TumoWWgYbGNFAUhKBUqsAII4P//////////ARAAGgwzMjk4NTM2NzAwODAiDHkQyUdOHdUk0seQTCqEAnbQeCEL/QrQb8VWXBGoq1MKMCkaUTRox9zqgDci/WXSFlX+Dia5qcLrE/acpBrluk0qTmfNjUkJhEOS/inuB/P+LW6Pj7yORJ+SGoUthDEj2nYH4cQ1dUefYvJJyzLJ0Gg2Nqj2a8WmITUywx8+zyTAvsUVOy7O64//AqjWeeOyAnen14jLXLEkFoWBk3OvHpawjV8JPCzh/oShS3t9/kil7fW9Ej/z6K1Sg+7mY4WcIcLHEF/gFajNuVvBT2sgHqY7a18LE3aVdLMlxwXg9TwM68vSV2rRfJpHkp+IlBPqQMQEcxN21wgH99lLOFNxK6dcHDuQ9d9lOklBqqyQJLbCEvr7MNPIp7sGOp0B3U0JS8SXeKZp46yVnLGaqyz1D7+ocFB4BgouQzwEKkxWVnhshLr/JlYom3xQtUkwOoKpWoPtcihG/SGsNAkdhsNoOZwqWOOyBjBITFOqbIXfr6uNMoY8zKO44dyibNeea2xmxe/7gpsiYVdBkm1IBlEYBMKQxfa/K075pyJVF5KK5Ko2qu3WxcG2b8FQo/+sAidkpgvA848vRKwgCA==
          LOCALSTACK_HOSTNAME: http://localhost:4566
          AWS_DEFAULT_REGION: us-east-1
        run: |
          python src/deployment.py
