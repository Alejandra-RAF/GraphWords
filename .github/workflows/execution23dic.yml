name: GraphWord Deployment Hybrid (AWS + LocalStack)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  setup-environment:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3

      - name: Configure AWS credentials
        run: |
          mkdir -p ~/.aws
          echo "[default]" > ~/.aws/credentials
          echo "aws_access_key_id = ASIAQXQZBCCF6GJOA2HF" >> ~/.aws/credentials
          echo "aws_secret_access_key = GMn3qgAq/0MFe6jz458HtOJ6WkyLsO9WQCnrByWX" >> ~/.aws/credentials
          echo "aws_session_token = IQoJb3JpZ2luX2VjEBgaCXVzLXdlc3QtMiJIMEYCIQCWB70wGHcYczCkFszNtEdCJKCBRDfLzS8Hm6q6PGeX5QIhAIVOJhVPTcYrm7QBH9rF2GrlajswsxVdyrgC2hbtDLiaKrACCOD//////////wEQARoMMDUwNTE4MzY0Mjk5Igwsnf6lw8daGdoQbyEqhAJRUuJZ1Ryct8ehwEJ/Cc4013fKYxdowARoviJbCayd6wn9OfiM6RBnoRAp4ZOH33uemN/yG5ZafAURCnLu2V6UD8hhUmzFY0tfoiT8/l+1KVmBWSsICueS6hiz8u+iJh+Ys2pHQdFUqBHLKiBd/OytB3kgqD3Naxf5FoN9iV6LEN941HdqRRVazQ1kiscbjm3hsMyWduQ4vSTDNnzwqVfHSK3GW5tLi3tHNLQfY23b4T/NAAPyWwewdq1gkv8lzMlAbPXYCmd0xreRDeI/kGK+Fjj/KpVxVlLpMfbfD3OKZxpwooOWvKfV3ROKCwxNfD78YsjbCZKsllt4kZCKaapk4MqYTjCG4ae7BjqcAU5QHP1wdRtY46o+LsPNjWgx61i/BpHyaNkf/7soGg61EhnC3EeX8kuHIRTSJa+cjjiwR5UKJu3aJ5SNHhae4OSWODzDExwwqNqgYgTOGLVae/aiVL+we85ZkIyT3eAqNCms477/CHGkoVAVeWgw6uVUnWojGP2+rd/h+uSwkC3J7hcO9ScUKpN+1iDDQRy0HD7xhvpJ0WzUNtScqQ==" >> ~/.aws/credentials
          echo "[default]" > ~/.aws/config
          echo "region = us-east-1" >> ~/.aws/config

  start-localstack:
    needs: setup-environment
    runs-on: ubuntu-22.04
    steps:
      - name: Start LocalStack using Docker
        run: |
          docker run -d --name localstack_main -p 4566:4566 -p 4571:4571 localstack/localstack
          sleep 10
          
      - name: Check LocalStack container
        run: |
          for i in {1..60}; do
            RUNNING=$(docker inspect -f '{{.State.Running}}' localstack_main || echo "false")
            if [ "$RUNNING" == "true" ]; then
              echo "LocalStack container is running."
              break
            fi
            echo "Waiting for LocalStack container to start..."
            sleep 5
          done
    
  run-deployment:
    needs: start-localstack
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3
          
      - name: Run deployment script
        env:
          AWS_ACCESS_KEY_ID: ASIAQXQZBCCF6GJOA2HF
          AWS_SECRET_ACCESS_KEY: GMn3qgAq/0MFe6jz458HtOJ6WkyLsO9WQCnrByWX
          AWS_SESSION_TOKEN: IQoJb3JpZ2luX2VjEBgaCXVzLXdlc3QtMiJIMEYCIQCWB70wGHcYczCkFszNtEdCJKCBRDfLzS8Hm6q6PGeX5QIhAIVOJhVPTcYrm7QBH9rF2GrlajswsxVdyrgC2hbtDLiaKrACCOD//////////wEQARoMMDUwNTE4MzY0Mjk5Igwsnf6lw8daGdoQbyEqhAJRUuJZ1Ryct8ehwEJ/Cc4013fKYxdowARoviJbCayd6wn9OfiM6RBnoRAp4ZOH33uemN/yG5ZafAURCnLu2V6UD8hhUmzFY0tfoiT8/l+1KVmBWSsICueS6hiz8u+iJh+Ys2pHQdFUqBHLKiBd/OytB3kgqD3Naxf5FoN9iV6LEN941HdqRRVazQ1kiscbjm3hsMyWduQ4vSTDNnzwqVfHSK3GW5tLi3tHNLQfY23b4T/NAAPyWwewdq1gkv8lzMlAbPXYCmd0xreRDeI/kGK+Fjj/KpVxVlLpMfbfD3OKZxpwooOWvKfV3ROKCwxNfD78YsjbCZKsllt4kZCKaapk4MqYTjCG4ae7BjqcAU5QHP1wdRtY46o+LsPNjWgx61i/BpHyaNkf/7soGg61EhnC3EeX8kuHIRTSJa+cjjiwR5UKJu3aJ5SNHhae4OSWODzDExwwqNqgYgTOGLVae/aiVL+we85ZkIyT3eAqNCms477/CHGkoVAVeWgw6uVUnWojGP2+rd/h+uSwkC3J7hcO9ScUKpN+1iDDQRy0HD7xhvpJ0WzUNtScqQ==
          AWS_DEFAULT_REGION: us-east-1
        run: |
          python src/deployment.py
