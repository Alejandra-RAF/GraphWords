name: GraphWord Deployment Hybrid (AWS + LocalStack)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  setup-environment:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3

      - name: Configure AWS credentials
        run: |
          mkdir -p ~/.aws
          echo "[default]" > ~/.aws/credentials
          echo "aws_access_key_id = ASIAUZTGPSLABVS322WM" >> ~/.aws/credentials
          echo "aws_secret_access_key = YP8F+sFtAxOqf/RcA+xZVJyeBh+ksiUQW+eeBnS/" >> ~/.aws/credentials
          echo "aws_session_token = IQoJb3JpZ2luX2VjEBcaCXVzLXdlc3QtMiJIMEYCIQDO28KriJ6lUTnpC1ags8qKRiqCY+igcv/7tbyy5zOn0QIhAPTzTfjAJvRyVTl6eiXcAM1vfAGO9/DcamBf2Y4cjKu+KrACCOD//////////wEQABoMMzI5ODUzNjcwMDgwIgzg8fKu37OQ7NJjRf0qhALh5xmpKkBTn56/7w4xkrfXHvXo/7dBtvtEoMT/wuJ3WSCtCqMu5nApgb1H11wyT7rWFmPFD4QCw7WriZr2Rj2nCLGCN29r/eqTiEIxeHXCUflCGnLflr7pqbkT2o4zT5yu721umIZ9TCtcQ9mArVJloeAdDMZKko91h/tqoiw1WXXM3hChSDcP6IFntvUbnR37dHrisWvfgLjRHKjz/hLFPkM4A1tXgJgHzmAOWZW4+6Eb+0WbfKT7gYRzUDmZj27vw26e6M5WkUWzYBSVgK6tZFzzeKs+zj0WeQcHWhuddCjBuS1SRE/dfjJ34gGF4U/DSNCGmdMM3VbkeekCYTkwkOfQcTDN26e7BjqcAdDGuwe6QGgupSLkt6+WtCvF5kI92J4Xd78+XzMtD/72vc4cmLbAClTttRpkAGJME4Dr/7X4dsv1bDgoZj3KIdm3aCg0uCzHpaggqSSZDFzAVe8i1aTG/otMW9mKFXl0o0gi678Zi21xwA5urSvacRLmlusvRpwVgxuB0Nauhn9KebX8bG15gBLLuwfo/K8biC/wOA2ib+NEceCRgg==" >> ~/.aws/credentials
          echo "[default]" > ~/.aws/config
          echo "region = us-east-1" >> ~/.aws/config

  start-localstack:
    needs: setup-environment
    runs-on: ubuntu-22.04
    steps:
      - name: Start LocalStack using Docker
        run: |
          docker run -d --name localstack_main -p 4566:4566 -p 4510-4559:4510-4559 -v /var/run/docker.sock:/var/run/docker.sock -e SERVICES="s3,lambda,ec2" localstack/localstack
          sleep 10
          
      - name: Check LocalStack container
        run: |
          for i in {1..60}; do
            RUNNING=$(docker inspect -f '{{.State.Running}}' localstack_main || echo "false")
            if [ "$RUNNING" == "true" ]; then
              echo "LocalStack container is running."
              break
            fi
            echo "Waiting for LocalStack container to start..."
            sleep 5
          done
    
  run-deployment:
    needs: start-localstack
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3
          
      - name: Run deployment script
        env:
          AWS_ACCESS_KEY_ID: ASIAUZTGPSLABVS322WM
          AWS_SECRET_ACCESS_KEY: YP8F+sFtAxOqf/RcA+xZVJyeBh+ksiUQW+eeBnS/
          AWS_SESSION_TOKEN: IQoJb3JpZ2luX2VjEBcaCXVzLXdlc3QtMiJIMEYCIQDO28KriJ6lUTnpC1ags8qKRiqCY+igcv/7tbyy5zOn0QIhAPTzTfjAJvRyVTl6eiXcAM1vfAGO9/DcamBf2Y4cjKu+KrACCOD//////////wEQABoMMzI5ODUzNjcwMDgwIgzg8fKu37OQ7NJjRf0qhALh5xmpKkBTn56/7w4xkrfXHvXo/7dBtvtEoMT/wuJ3WSCtCqMu5nApgb1H11wyT7rWFmPFD4QCw7WriZr2Rj2nCLGCN29r/eqTiEIxeHXCUflCGnLflr7pqbkT2o4zT5yu721umIZ9TCtcQ9mArVJloeAdDMZKko91h/tqoiw1WXXM3hChSDcP6IFntvUbnR37dHrisWvfgLjRHKjz/hLFPkM4A1tXgJgHzmAOWZW4+6Eb+0WbfKT7gYRzUDmZj27vw26e6M5WkUWzYBSVgK6tZFzzeKs+zj0WeQcHWhuddCjBuS1SRE/dfjJ34gGF4U/DSNCGmdMM3VbkeekCYTkwkOfQcTDN26e7BjqcAdDGuwe6QGgupSLkt6+WtCvF5kI92J4Xd78+XzMtD/72vc4cmLbAClTttRpkAGJME4Dr/7X4dsv1bDgoZj3KIdm3aCg0uCzHpaggqSSZDFzAVe8i1aTG/otMW9mKFXl0o0gi678Zi21xwA5urSvacRLmlusvRpwVgxuB0Nauhn9KebX8bG15gBLLuwfo/K8biC/wOA2ib+NEceCRgg==
          AWS_DEFAULT_REGION: us-east-1
        run: |
          python src/deployment.py
