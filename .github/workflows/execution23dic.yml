name: GraphWord Deployment with LocalStack

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  setup-environment:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3

  start-localstack:
    needs: setup-environment
    runs-on: ubuntu-22.04
    steps:
      - name: Start LocalStack using Docker
        run: |
          docker run -d --name localstack_main -p 4566:4566 -p 4571:4571 localstack/localstack
      - name: Wait for LocalStack to start
        run: |
          for i in {1..10}; do
            curl -s http://localhost:4566/health | grep "\"status\": \"running\"" && break
            echo "Waiting for LocalStack to start..."
            sleep 5
          done
      - name: Verify LocalStack is running
        run: curl http://localhost:4566/health

  run-deployment:
    needs: start-localstack
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python (again, for context isolation)
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies (again, if needed)
        run: |
          python -m pip install --upgrade pip
          pip install boto3

      - name: Run deployment script
        run: |
          python src/deployment.py
