name: GraphWord Deployment Hybrid (AWS + LocalStack)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  setup-environment:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3

      - name: Configure AWS credentials
        run: |
          mkdir -p ~/.aws
          echo "[default]" > ~/.aws/credentials
          echo "aws_access_key_id = ASIAQXQZBCCF77URH6L5" >> ~/.aws/credentials
          echo "aws_secret_access_key = uQTMVuOSpdoYBqo4HKRj+Y87JxB2x+S7Ed3T0DH/" >> ~/.aws/credentials
          echo "aws_session_token = IQoJb3JpZ2luX2VjEBcaCXVzLXdlc3QtMiJHMEUCIGZZSvGY62ZyTWb8TrFcNcZA8TpiWMacT7ialmWhNQAKAiEA8eX4O3vlsKlTy49fJmA4Ntlrh3IF7foKw+y1C/4XeRcqsAII4P//////////ARABGgwwNTA1MTgzNjQyOTkiDONMrS55QuZBPdDcYSqEAlxe7KLV3ZYgNuP6uRpR0ovEpJDav/gPowsEe4rii4tTolA85eND1p2TrYleaxibyVnm8lHHQ4H7qFJmKkBD4gVRbeJbFrOTO+Se8KshZUSewf49Z4YfiU0v9ln84BoK5o0Fc5J0veAwVMXRchFooq4X/xvhP40KZ5FF542FO5MRFj0SVHfl8ORym2Or/BtuQ5VaVflYhM7B6GHAaVdeQdrsB76FyU48SurNeyDu6TYkc6oRds/27xUYL+8s8MgoEgj5RK6TWfKy2ia3mNhifY4qId/z4EZK5auXzVbOZ6/62cTrJ53CcTsF8aOMNvzkwdjwvpaAFK4nATvBEjMP5ftRFcCnMPDRp7sGOp0BuyGmkDUNIXbK3SAPTKHY7ZgKRg8xUeeA0kjr5HyKEtsNxkofETFkMUvjqbtjAlNZAPxrmt9NgwsDUcAT5nFbA7xt7keWPIic4JyE1o9MlmkLjD7Vi4lgxnJuOuV4WmXUR+oRkW02vG7cx68zs2wmlNe3huN39pwMih7R1rJ3nivQYsOUHb+MDMC/UWUNIUaxRbzDHkdIMZ8pgoAj8w==" >> ~/.aws/credentials
          echo "[default]" > ~/.aws/config
          echo "region = us-east-1" >> ~/.aws/config

  start-localstack:
    needs: setup-environment
    runs-on: ubuntu-22.04
    steps:
      - name: Start LocalStack using Docker
        run: |
          docker run -d --name localstack_main -p 4566:4566 -p 4510-4559:4510-4559 -v /var/run/docker.sock:/var/run/docker.sock -e SERVICES="s3,lambda,ec2" localstack/localstack
          sleep 10
          
      - name: Check LocalStack container
        run: |
          for i in {1..60}; do
            RUNNING=$(docker inspect -f '{{.State.Running}}' localstack_main || echo "false")
            if [ "$RUNNING" == "true" ]; then
              echo "LocalStack container is running."
              break
            fi
            echo "Waiting for LocalStack container to start..."
            sleep 5
          done
    
  run-deployment:
    needs: start-localstack
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3
          
      - name: Run deployment script
        env:
          AWS_ACCESS_KEY_ID: ASIAQXQZBCCF77URH6L5
          AWS_SECRET_ACCESS_KEY: uQTMVuOSpdoYBqo4HKRj+Y87JxB2x+S7Ed3T0DH/
          AWS_SESSION_TOKEN: IQoJb3JpZ2luX2VjEBcaCXVzLXdlc3QtMiJHMEUCIGZZSvGY62ZyTWb8TrFcNcZA8TpiWMacT7ialmWhNQAKAiEA8eX4O3vlsKlTy49fJmA4Ntlrh3IF7foKw+y1C/4XeRcqsAII4P//////////ARABGgwwNTA1MTgzNjQyOTkiDONMrS55QuZBPdDcYSqEAlxe7KLV3ZYgNuP6uRpR0ovEpJDav/gPowsEe4rii4tTolA85eND1p2TrYleaxibyVnm8lHHQ4H7qFJmKkBD4gVRbeJbFrOTO+Se8KshZUSewf49Z4YfiU0v9ln84BoK5o0Fc5J0veAwVMXRchFooq4X/xvhP40KZ5FF542FO5MRFj0SVHfl8ORym2Or/BtuQ5VaVflYhM7B6GHAaVdeQdrsB76FyU48SurNeyDu6TYkc6oRds/27xUYL+8s8MgoEgj5RK6TWfKy2ia3mNhifY4qId/z4EZK5auXzVbOZ6/62cTrJ53CcTsF8aOMNvzkwdjwvpaAFK4nATvBEjMP5ftRFcCnMPDRp7sGOp0BuyGmkDUNIXbK3SAPTKHY7ZgKRg8xUeeA0kjr5HyKEtsNxkofETFkMUvjqbtjAlNZAPxrmt9NgwsDUcAT5nFbA7xt7keWPIic4JyE1o9MlmkLjD7Vi4lgxnJuOuV4WmXUR+oRkW02vG7cx68zs2wmlNe3huN39pwMih7R1rJ3nivQYsOUHb+MDMC/UWUNIUaxRbzDHkdIMZ8pgoAj8w==
          LOCALSTACK_HOSTNAME: http://localhost:4566
          AWS_DEFAULT_REGION: us-east-1
        run: |
          python src/deployment.py
